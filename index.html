<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personalized Launchpad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom font and base styles */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scroll */
        }
        #background-container {
            /* Initial placeholder for safe loading */
            background-image: url('https://placehold.co/1920x1080/0f172a/94a3b8?text=Loading+Background');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            filter: brightness(0.4); /* Darken for better text contrast */
            transition: background-image 1s ease-in-out; /* Smooth background transition */
        }
        .scroll-container {
            overflow-y: auto;
            height: 100vh;
            padding: 20px;
        }
        /* Custom scrollbar for a sleek look */
        .scroll-container::-webkit-scrollbar { width: 6px; }
        .scroll-container::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 3px; }
        .scroll-container::-webkit-scrollbar-track { background: transparent; }

        .bookmark-icon {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .bookmark-icon:hover {
            transform: scale(1.1) translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -4px rgba(0, 0, 0, 0.3);
            border-color: #3b82f6;
        }
        .mcast-link-item {
            transition: background-color 0.3s, transform 0.3s;
            cursor: pointer; /* Indicate it's clickable */
        }
        .mcast-link-item:hover {
            background-color: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }
        /* Standard transition for projects/assignments/bookmarks */
        .delete-btn {
            opacity: 0;
            transition: opacity 0.2s;
        }
        .assignment-item:hover .delete-btn,
        .bookmark-item-wrap:hover .delete-btn {
            opacity: 1;
        }

        /* NEW: Styles for background gallery thumbnails */
        .background-thumbnail {
            width: 100%;
            padding-top: 56.25%; /* 16:9 Aspect Ratio */
            background-size: cover;
            background-position: center;
            cursor: pointer;
            border: 3px solid transparent;
            transition: border-color 0.3s, opacity 0.3s;
        }
        .background-thumbnail:hover {
            border-color: #3b82f6; /* Blue border on hover */
            opacity: 0.8;
        }
        .background-thumbnail.selected {
            border-color: #10b981; /* Green border for selected */
            border-width: 4px;
        }
    </style>

    <script>
        // Define fallback variables in global scope for use in the module script below.
        const LOCAL_FIREBASE_CONFIG_JSON = JSON.stringify({
           apiKey: "AIzaSyDRYcVVOg_yzTbYQnBj7TxghX-2rNT3f3g",
           authDomain: "personalment-c1a9c.firebaseapp.com",
           projectId: "personalment-c1a9c",
           storageBucket: "personalment-c1a9c.firebasestorage.app",
           messagingSenderId: "461177689665",
           appId: "1:461177689665:web:bddc74fe94c21c097d18c0",
           measurementId: "G-RC5MS7QBNK"
        });
        const LOCAL_AUTH_TOKEN = null; 
    </script>
    <script type="module">
        // --- USING v12.4.0 CDN LINKS AS REQUESTED ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, setLogLevel } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
        // --- END v12.4.0 IMPORTS ---

        // Determine environment: Use Canvas globals OR local fallbacks
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // FIX: Accessing LOCAL_FIREBASE_CONFIG_JSON and LOCAL_AUTH_TOKEN which are now globally defined.
        const configSource = typeof __firebase_config !== 'undefined' ? __firebase_config : LOCAL_FIREBASE_CONFIG_JSON;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : LOCAL_AUTH_TOKEN;

        // Parse the configuration
        const firebaseConfig = JSON.parse(configSource);
        
        let db, auth, userId = null;
        let isAuthReady = false;

        setLogLevel('debug'); // Enable Firestore logging

        // Utility function to get the current collection path for private user data
        const getCollectionPath = (collectionName) => `/artifacts/${appId}/users/${userId}/${collectionName}`;

        // Initialize Firebase and Authentication
        const initFirebase = async () => {
            try {
                // Initialize app with the provided configuration
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in with custom token if available, otherwise sign in anonymously.
                if (initialAuthToken) {
                    console.log("Attempting sign-in with custom token...");
                    await signInWithCustomToken(auth, initialAuthToken).catch(e => {
                        console.warn("Custom token sign-in failed, trying anonymous:", e);
                        return signInAnonymously(auth);
                    });
                } else {
                    console.log("Attempting anonymous sign-in...");
                    await signInAnonymously(auth);
                }

                // Wait for auth state to be resolved
                onAuthStateChanged(auth, (user) => {
                    if (user && user.uid) {
                        userId = user.uid; 
                        isAuthReady = true;
                        console.log("Firebase Auth Ready. User ID:", userId);

                        // Once ready, start loading persistent data
                        setupDataListeners();
                        // Display the user ID for debugging/sharing purposes
                        document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                    } else {
                         // If onAuthStateChanged resolves without a user (e.g., failed to get a custom/anonymous token)
                         // Set a temporary user ID and call mock data as a last resort.
                         userId = crypto.randomUUID();
                         isAuthReady = true;
                         console.log("Auth state resolved without persistent user. Activating Mock Mode via listener fallback.");
                         window.setupMockData();
                    }
                });

            } catch (error) {
                // This catch block is only for core initialization failures (e.g., bad config, network)
                console.error("Firebase Initialization failed, falling back to Mock Mode:", error);
                window.setupMockData(); 
            }
        };

        // --- Data Listener Setup (Only runs if Firestore is successfully initialized) ---
        const setupDataListeners = () => {
            if (!db || !userId) { 
                console.error("Cannot set up listeners: DB not initialized or User ID missing.");
                return;
            }

            // 1. Assignments Listener
            onSnapshot(collection(db, getCollectionPath('assignments')), (snapshot) => {
                const assignments = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    let deadlineDate;
                    
                    if (data.deadline && typeof data.deadline.toDate === 'function') {
                        deadlineDate = data.deadline.toDate();
                    } else if (data.deadline) {
                        deadlineDate = new Date(data.deadline);
                    } else {
                        deadlineDate = null;
                    }
                    assignments.push({ id: doc.id, ...data, deadline: deadlineDate });
                });
                
                assignments.sort((a, b) => (a.deadline || 0) - (b.deadline || 0));
                window.renderAssignments(assignments);
            }, (error) => {
                console.error("Error fetching assignments:", error);
            });

            // 2. Bookmarks Listener
            onSnapshot(collection(db, getCollectionPath('bookmarks')), (snapshot) => {
                const bookmarks = [];
                snapshot.forEach(doc => {
                    bookmarks.push({ id: doc.id, ...doc.data() });
                });
                window.renderBookmarks(bookmarks);
            }, (error) => {
                console.error("Error fetching bookmarks:", error);
            });
            
            // 3. Backgrounds Listener (NEW)
            onSnapshot(collection(db, getCollectionPath('backgrounds')), (snapshot) => {
                const userBackgrounds = [];
                snapshot.forEach(doc => {
                    // Only push the Base64 string for use in the CSS
                    userBackgrounds.push({ id: doc.id, name: doc.data().name || 'Background', base64: doc.data().base64 });
                });
                window.setUserBackgrounds(userBackgrounds);
                window.renderBackgroundGallery(userBackgrounds); // RENDER GALLERY
            }, (error) => {
                console.error("Error fetching backgrounds:", error);
            });
        };

        // --- Firebase Data Operations (Global Functions) ---
        window.db = {
            // Assignment CRUD (existing)
            addAssignment: async (title, deadlineDate) => {
                if (!db || !userId || !isAuthReady) { console.error("Firestore not initialized for persistence."); return; }
                try {
                    await addDoc(collection(db, getCollectionPath('assignments')), {
                        title: title,
                        // Storing date as ISO string is better for cross-platform/language consistency in Firestore
                        deadline: deadlineDate.toISOString(), 
                        createdAt: new Date().toISOString()
                    });
                    console.log("Assignment added to Firestore successfully.");
                } catch (e) { console.error("Error adding document: ", e); }
            },
            deleteAssignment: async (id) => {
                if (!db || !userId || !isAuthReady) { console.error("Firestore not initialized for persistence."); return; }
                try {
                    await deleteDoc(doc(db, getCollectionPath('assignments'), id));
                    console.log("Assignment deleted from Firestore successfully.");
                } catch (e) { console.error("Error deleting document: ", e); }
            },

            // Bookmark CRUD (existing)
            addBookmark: async (name, url, icon) => {
                if (!db || !userId || !isAuthReady) { console.error("Firestore not initialized for persistence."); return; }
                try {
                    await addDoc(collection(db, getCollectionPath('bookmarks')), {
                        name: name,
                        url: url,
                        icon: icon,
                    });
                    console.log("Bookmark added to Firestore successfully.");
                } catch (e) { console.error("Error adding bookmark: ", e); }
            },
            deleteBookmark: async (id) => {
                if (!db || !userId || !isAuthReady) { console.error("Firestore not initialized for persistence."); return; }
                try {
                    await deleteDoc(doc(db, getCollectionPath('bookmarks'), id));
                    console.log("Bookmark deleted from Firestore successfully.");
                } catch (e) { console.error("Error deleting bookmark: ", e); }
            },

            // Background CRUD (NEW)
            addBackground: async (base64String, fileName) => {
                if (!db || !userId || !isAuthReady) { console.error("Firestore not initialized for persistence."); return; }
                try {
                    await addDoc(collection(db, getCollectionPath('backgrounds')), {
                        base64: base64String, // The image data
                        name: fileName,
                        uploadedAt: new Date().toISOString()
                    });
                    console.log(`Background '${fileName}' added to Firestore successfully.`);
                } catch (e) { console.error("Error adding background: ", e); }
            },
            deleteBackground: async (id) => {
                if (!db || !userId || !isAuthReady) { console.error("Firestore not initialized for persistence."); return; }
                try {
                    await deleteDoc(doc(db, getCollectionPath('backgrounds'), id));
                    console.log("Background deleted from Firestore successfully.");
                } catch (e) { console.error("Error deleting background: ", e); }
            },
        };

        initFirebase();
    </script>

    <script>
        // --- Custom Background Image Array ---
        let USER_BACKGROUNDS = [];
        // Use localStorage to persist the ID of the currently selected background
        const CURRENT_BG_KEY = 'currentBackgroundId';
        let currentBackgroundId = localStorage.getItem(CURRENT_BG_KEY) || null;
        let backgroundContainer;

        /** Sets the user's available backgrounds array. */
        window.setUserBackgrounds = (newBackgrounds) => {
            USER_BACKGROUNDS = newBackgrounds;
            
            // Check if the current ID is still valid, if not, pick the first one.
            const isCurrentValid = USER_BACKGROUNDS.some(bg => bg.id === currentBackgroundId);
            if (!isCurrentValid && USER_BACKGROUNDS.length > 0) {
                 // Set the first background as the default if the stored ID is invalid/deleted
                 currentBackgroundId = USER_BACKGROUNDS[0].id;
                 localStorage.setItem(CURRENT_BG_KEY, currentBackgroundId);
            } else if (USER_BACKGROUNDS.length === 0) {
                 currentBackgroundId = null;
                 localStorage.removeItem(CURRENT_BG_KEY);
            }
            
            // Update the display with the determined current background
            changeBackground(currentBackgroundId);
        }

        /** Sets the current background to the one matching the given ID. */
        const changeBackground = (backgroundId) => {
            if (!backgroundContainer) {
                backgroundContainer = document.getElementById('background-container');
            }
            
            // Find the background object
            const selectedBackground = USER_BACKGROUNDS.find(bg => bg.id === backgroundId);

            if (selectedBackground) {
                // Set as current and save to local storage
                currentBackgroundId = selectedBackground.id;
                localStorage.setItem(CURRENT_BG_KEY, currentBackgroundId);

                // Set the CSS background to the Base64 string
                backgroundContainer.style.backgroundImage = `url('${selectedBackground.base64}')`;
            } else {
                // Fallback if no backgrounds are available
                currentBackgroundId = null;
                localStorage.removeItem(CURRENT_BG_KEY);
                backgroundContainer.style.backgroundImage = `url('https://placehold.co/1920x1080/0f172a/94a3b8?text=Add+Your+First+Background')`;
            }
        };

        /** Renders the gallery content inside the modal. */
        window.renderBackgroundGallery = (userBackgrounds) => {
            const galleryContainer = document.getElementById('background-gallery-grid');
            galleryContainer.innerHTML = ''; // Clear gallery

            if (userBackgrounds.length === 0) {
                 galleryContainer.innerHTML = '<p class="text-white/50 text-center col-span-full">No backgrounds uploaded yet. Use the form below to add one!</p>';
                 return;
            }

            userBackgrounds.forEach(bg => {
                const isSelected = bg.id === currentBackgroundId;
                const item = document.createElement('div');
                item.className = 'relative group';
                item.innerHTML = `
                    <div class="background-thumbnail rounded-xl overflow-hidden shadow-lg border-2" 
                         style="background-image: url('${bg.base64}');"
                         data-bg-id="${bg.id}"
                         title="Click to select: ${bg.name}">
                         </div>
                    <span class="absolute top-2 left-2 px-2 py-1 bg-black/50 text-white text-xs rounded-full opacity-80">${bg.name}</span>
                    <button onclick="window.db.deleteBackground('${bg.id}')"
                            class="absolute top-2 right-2 bg-red-500 text-white rounded-full p-1 shadow-md hover:bg-red-600 transition-opacity opacity-0 group-hover:opacity-100"
                            title="Delete Background">
                        <span data-lucide="x" class="w-4 h-4"></span>
                    </button>
                `;

                // Add click listener to select background
                item.querySelector('.background-thumbnail').addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-bg-id');
                    changeBackground(id); // Set as current
                    
                    // Update visual selection in the gallery immediately
                    document.querySelectorAll('.background-thumbnail').forEach(el => el.classList.remove('selected'));
                    e.currentTarget.classList.add('selected');
                });

                // Set the 'selected' class if this is the currently active background
                if (isSelected) {
                    item.querySelector('.background-thumbnail').classList.add('selected');
                }
                
                galleryContainer.appendChild(item);
            });
            lucide.createIcons(); // Initialize icons
        }
        // --- END Custom Background Logic ---


        // --- Mock Data and Configuration ---

        // Mock Assignments for fallback
        let MOCK_ASSIGNMENTS = [];
        const getMockAssignments = () => {
            if (MOCK_ASSIGNMENTS.length === 0) {
                const now = new Date();
                const tomorrow = new Date(now.getTime() + (24 * 60 * 60 * 1000));
                const nextWeek = new Date(now.getTime() + (7 * 24 * 60 * 60 * 1000));
                MOCK_ASSIGNMENTS = [
                    // Ensure mock deadlines are in the future for display
                    { id: 'mock1', title: 'Database Design Exam (Mock)', deadline: tomorrow, createdAt: new Date() },
                    { id: 'mock2', title: 'Physics Lab Report (Mock)', deadline: nextWeek, createdAt: new Date() },
                ];
            }
            return MOCK_ASSIGNMENTS;
        };

        // Mock Bookmarks for fallback
        let MOCK_BOOKMARKS = [
            { id: 'bm1', name: "Gemini", url: "https://gemini.google.com/", icon: "sparkles" },
            { id: 'bm2', name: "GitHub", url: "https://github.com/", icon: "code" },
            { id: 'bm3', name: "Learn", url: "https://www.udemy.com/", icon: "book-open" },
            { id: 'bm4', name: "Mail", url: "https://mail.google.com/", icon: "mail" },
        ];
        
        // Mock Backgrounds for fallback (Simple placeholder)
        let MOCK_BACKGROUNDS = [
            { id: 'bg1', name: 'Mock Sunset', base64: 'https://placehold.co/1920x1080/1e3a8a/bfdbfe?text=MOCK+BACKGROUND' }
        ];

        // --- MCAST Links Data (New Section) ---
        const MCAST_LINKS = [
            // General Links
            { name: "MCAST Classter", url: "https://mcast.classter.com", icon: "school" },
            { name: "Dissertations (Moodle)", url: "https://moodle.mcast.edu.mt/enrol/index.php?id=251", icon: "book-open-check" },
            // Subject Links
            { name: "Systems Programming", url: "https://vle.mcast.edu.mt/course/view.php?id=5314", icon: "laptop" },
            { name: "Image Processing & Vision", url: "https://vle.mcast.edu.mt/course/view.php?id=57", icon: "image" },
            { name: "Data Structures & Algorithms II", url: "https://vle.mcast.edu.mt/course/view.php?id=127", icon: "git-branch" },
            { name: "Statistics for Computer Science", url: "https://vle.mcast.edu.mt/course/view.php?id=133", icon: "bar-chart-2" },
        ];
        // --- END MCAST Links Data ---


        // --- State Management ---
        let assignments = [];
        let bookmarks = []; 
        let countdownInterval;

        // --- Mock Data Setup (Called if Firestore is unavailable) ---
        window.setupMockData = () => {
            // Load mock bookmarks
            bookmarks = MOCK_BOOKMARKS;
            window.renderBookmarks(bookmarks);

            // Load mock assignments 
            assignments = getMockAssignments();
            window.renderAssignments(assignments);

            // Load mock backgrounds
            window.setUserBackgrounds(MOCK_BACKGROUNDS);
            window.renderBackgroundGallery(MOCK_BACKGROUNDS); // RENDER GALLERY
            
            // Render MCAST links
            window.renderMCASTLinks();

            // Override global DB functions to only handle local state for mock mode
            window.db = {
                // Assignments Mock
                addAssignment: (title, deadlineDate) => {
                    const newAssignment = { id: crypto.randomUUID(), title: `${title} (Mock)`, deadline: deadlineDate, createdAt: new Date() };
                    assignments.push(newAssignment);
                    assignments.sort((a, b) => (a.deadline || 0) - (b.deadline || 0));
                    window.renderAssignments(assignments);
                    console.warn("MOCK MODE: Assignment added locally, but will NOT persist on refresh.");
                },
                deleteAssignment: (id) => {
                    assignments = assignments.filter(a => a.id !== id);
                    window.renderAssignments(assignments);
                    console.warn("MOCK MODE: Assignment deleted locally.");
                },

                // Bookmarks Mock
                addBookmark: (name, url, icon) => {
                    const newBookmark = { id: crypto.randomUUID(), name: name, url: url, icon: icon };
                    bookmarks.push(newBookmark);
                    window.renderBookmarks(bookmarks);
                    console.warn(`MOCK MODE: Bookmark '${name}' added locally (not persistent).`);
                },
                deleteBookmark: (id) => {
                    bookmarks = bookmarks.filter(b => b.id !== id);
                    window.renderBookmarks(bookmarks);
                    console.warn("MOCK MODE: Bookmark deleted locally.");
                },

                // Backgrounds Mock
                addBackground: (base64String, fileName) => {
                    const newBackground = { id: crypto.randomUUID(), name: fileName, base64: base64String };
                    MOCK_BACKGROUNDS.push(newBackground);
                    window.setUserBackgrounds(MOCK_BACKGROUNDS);
                    window.renderBackgroundGallery(MOCK_BACKGROUNDS);
                    console.warn(`MOCK MODE: Background '${fileName}' added locally (not persistent).`);
                },
                deleteBackground: (id) => {
                    MOCK_BACKGROUNDS = MOCK_BACKGROUNDS.filter(b => b.id !== id);
                    window.setUserBackgrounds(MOCK_BACKGROUNDS);
                    window.renderBackgroundGallery(MOCK_BACKGROUNDS);
                    console.warn("MOCK MODE: Background deleted locally.");
                }
            };
        };


        // --- Utility Functions ---

        /** Pads a number with a leading zero if it's less than 10. */
        const padZero = (num) => String(Math.floor(num)).padStart(2, '0');

        /** Converts milliseconds into a countdown object {d, h, m, s} */
        const getTimeRemaining = (endTime) => {
            const total = endTime - new Date();
            const seconds = padZero((total / 1000) % 60);
            const minutes = padZero((total / (1000 * 60)) % 60);
            const hours = padZero((total / (1000 * 60 * 60)) % 24);
            const days = padZero(total / (1000 * 60 * 60 * 24));

            return { total, days, hours, minutes, seconds };
        };

        /** Converts a File object to a Base64 string. */
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        };
        
        // --- Rendering Functions (No change here, just included for completeness) ---

        /** Renders the MCAST links list. */
        window.renderMCASTLinks = () => {
            const container = document.getElementById('mcast-link-list');
            
            container.innerHTML = MCAST_LINKS.map(link => `
                <div class="mcast-link-item-wrap relative flex items-center group">
                    <a href="${link.url}" 
                       target="_blank" 
                       rel="noopener noreferrer"
                       title="${link.name}"
                       class="mcast-link-item block w-full text-left p-3 pr-4 rounded-xl bg-white/10 text-white hover:bg-white/20 backdrop-blur-sm transition-all duration-300">
                        <span data-lucide="${link.icon || 'link'}" class="inline-block w-4 h-4 mr-2"></span>
                        ${link.name}
                    </a>
                </div>
            `).join('');
            lucide.createIcons(); // Initialize icons
        };

        /** Renders the bookmarks from Firestore (or Mock Data). */
        window.renderBookmarks = (newBookmarks) => {
            bookmarks = newBookmarks;
            const container = document.getElementById('bookmark-container');
            container.innerHTML = bookmarks.map(b => `
                <div class="bookmark-item-wrap relative">
                    <a href="${b.url}" target="_blank" rel="noopener noreferrer" title="${b.name}"
                        class="bookmark-icon flex flex-col items-center justify-center w-16 h-16 sm:w-20 sm:h-20 bg-white/10 border border-white/20 rounded-2xl hover:border-blue-400">
                        <span data-lucide="${b.icon || 'star'}" class="w-8 h-8 text-white"></span>
                        <span class="text-xs text-white/80 mt-1 truncate max-w-full">${b.name}</span>
                    </a>
                    <button onclick="window.db.deleteBookmark('${b.id}')"
                            class="delete-btn absolute top-[-5px] right-[-5px] bg-red-500 text-white rounded-full p-1 shadow-md hover:bg-red-600 transition-colors">
                        <span data-lucide="x" class="w-3 h-3"></span>
                    </button>
                </div>
            `).join('');

            // Add the 'Add Bookmark' button at the end
            container.innerHTML += `
                <button id="open-bookmark-modal-btn"
                        class="flex flex-col items-center justify-center w-16 h-16 sm:w-20 sm:h-20 bg-white/5 border border-white/10 rounded-2xl text-white/50 hover:text-white hover:border-blue-500 transition-all duration-300"
                        title="Add New Bookmark">
                    <span data-lucide="plus" class="w-6 h-6"></span>
                    <span class="text-xs mt-1">Add</span>
                </button>
            `;
            
            // Re-attach event listener for the new button
            document.getElementById('open-bookmark-modal-btn')?.addEventListener('click', openBookmarkModal);

            lucide.createIcons();
        };

        /** Renders the assignment list and manages the countdown timer. */
        window.renderAssignments = (newAssignments) => {
            assignments = newAssignments;
            const list = document.getElementById('assignment-list');
            list.innerHTML = ''; // Clear existing list

            if (assignments.length === 0) {
                list.innerHTML = '<p class="text-white/50 text-center mt-4">No upcoming assignments. Add one!</p>';
            }

            assignments.forEach(assignment => {
                // Ensure deadline is a Date object before calculating
                const deadlineDate = assignment.deadline instanceof Date ? assignment.deadline : new Date(assignment.deadline);

                const countdownHTML = `
                    <div id="countdown-${assignment.id}" class="text-xs font-mono text-yellow-300 mt-1">
                        Calculating...
                    </div>
                `;
                const item = document.createElement('div');
                item.id = `assignment-item-${assignment.id}`; // Add ID for better targeting
                item.className = 'assignment-item flex justify-between items-start p-3 rounded-lg bg-white/5 backdrop-blur-sm shadow-md transition-all duration-300';
                item.innerHTML = `
                    <div>
                        <p class="text-sm font-semibold text-white">${assignment.title}</p>
                        <p class="text-xs text-white/70">${deadlineDate.toLocaleDateString()}</p>
                        ${countdownHTML}
                    </div>
                    <button onclick="window.db.deleteAssignment('${assignment.id}')"
                            class="delete-btn text-red-400 hover:text-red-500 transition-colors duration-200 p-1 rounded">
                        <span data-lucide="x" class="w-4 h-4"></span>
                    </button>
                `;
                list.appendChild(item);
            });

            // Re-create lucide icons for the new elements
            lucide.createIcons();

            // Clear previous interval and start a new one
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            countdownInterval = setInterval(updateCountdowns, 1000);
        };

        /** Updates the countdown display for all assignments every second. */
        const updateCountdowns = () => {
            assignments.forEach(assignment => {
                const countdownEl = document.getElementById(`countdown-${assignment.id}`);
                if (!countdownEl) return;

                // Ensure deadline is a Date object for calculation
                const deadlineDate = assignment.deadline instanceof Date ? assignment.deadline : new Date(assignment.deadline);
                const remaining = getTimeRemaining(deadlineDate);

                if (remaining.total <= 0) {
                    countdownEl.innerHTML = '<span class="text-red-400">!! DEADLINE PASSED !!</span>';
                    return;
                }

                countdownEl.innerHTML = `
                    <span class="font-bold">${remaining.days}</span>d
                    <span class="font-bold">${remaining.hours}</span>h
                    <span class="font-bold">${remaining.minutes}</span>m
                    <span class="font-bold">${remaining.seconds}</span>s
                `;
            });
        };


        // --- Modal Logic ---

        // Assignment Modal
        const openAssignmentModal = () => document.getElementById('assignment-modal').classList.remove('opacity-0', 'pointer-events-none');
        const closeAssignmentModal = () => document.getElementById('assignment-modal').classList.add('opacity-0', 'pointer-events-none');

        const handleAddAssignment = async () => {
            const titleInput = document.getElementById('assignment-title');
            const deadlineInput = document.getElementById('assignment-deadline');

            const title = titleInput.value.trim();
            const deadline = deadlineInput.value;

            if (!title || !deadline) {
                console.error('Validation Error: Please enter both a title and a deadline.');
                return;
            }

            try {
                const deadlineDate = new Date(deadline);
                
                await window.db.addAssignment(title, deadlineDate); 

                // Reset form and close modal
                titleInput.value = '';
                deadlineInput.value = '';
                closeAssignmentModal();
            } catch (error) {
                console.error("Failed to add assignment:", error);
            }
        };

        // Bookmark Modal
        const openBookmarkModal = () => document.getElementById('bookmark-modal').classList.remove('opacity-0', 'pointer-events-none');
        const closeBookmarkModal = () => document.getElementById('bookmark-modal').classList.add('opacity-0', 'pointer-events-none');

        const handleAddBookmark = async () => {
            const nameInput = document.getElementById('bookmark-name');
            const urlInput = document.getElementById('bookmark-url');
            const iconInput = document.getElementById('bookmark-icon'); 

            const name = nameInput.value.trim();
            const url = urlInput.value.trim();
            const icon = iconInput.value.trim() || 'link'; 

            if (!name || !url) {
                console.error('Validation Error: Please enter both a name and a URL.');
                return;
            }

            try {
                const validUrl = url.startsWith('http://') || url.startsWith('https://') || url.startsWith('file:///') ? url : `https://${url}`;

                await window.db.addBookmark(name, validUrl, icon);

                // Reset form and close modal
                nameInput.value = '';
                urlInput.value = '';
                iconInput.value = '';
                closeBookmarkModal();
            } catch (error) {
                console.error("Failed to add bookmark:", error);
            }
        };
        
        // Background Gallery Modal (NEW)
        const openBackgroundGalleryModal = () => document.getElementById('background-gallery-modal').classList.remove('opacity-0', 'pointer-events-none');
        const closeBackgroundGalleryModal = () => {
            document.getElementById('background-image-file').value = ''; // Reset file input
            document.getElementById('background-gallery-modal').classList.add('opacity-0', 'pointer-events-none');
        }

        const handleAddBackground = async () => {
            const fileInput = document.getElementById('background-image-file');
            const file = fileInput.files[0];
            const fileNameInput = document.getElementById('background-file-name');
            const fileName = fileNameInput.value.trim() || file.name;


            if (!file) {
                console.error('Validation Error: Please select an image file.');
                return;
            }
            
            // Basic file validation
            if (!file.type.startsWith('image/')) {
                 console.error('Validation Error: File must be an image.');
                 return;
            }
            
            // Limit file size to 2MB to prevent Firebase document size limit issues (1 MiB limit is the hard limit)
            const MAX_SIZE = 2 * 1024 * 1024; // 2MB
            if (file.size > MAX_SIZE) {
                alert('Image file is too large. Please upload an image under 2MB.');
                return;
            }

            try {
                // Convert to Base64
                const base64String = await fileToBase64(file);

                // Save to Firestore
                await window.db.addBackground(base64String, fileName);

                // Clear form inputs
                fileInput.value = ''; 
                fileNameInput.value = '';
                // The listener will automatically re-render the gallery and update the background.
            } catch (error) {
                console.error("Failed to add background:", error);
                alert("An error occurred during upload. Check console for details.");
            }
        };


        // --- Main Initialization ---
        window.onload = () => {
            // Initial background will be set by the listener fetching user data, 
            // but we call changeBackground(null) here to set the initial fallback image.
            changeBackground(currentBackgroundId); 
            
            // Explicitly call renderMCASTLinks to ensure the list displays immediately
            window.renderMCASTLinks(); 

            // Attach event listeners for Assignment Modal
            document.getElementById('open-assignment-modal-btn').addEventListener('click', openAssignmentModal);
            document.getElementById('close-assignment-modal-btn').addEventListener('click', closeAssignmentModal);
            document.getElementById('add-assignment-btn').addEventListener('click', handleAddAssignment);
            
            // Attach event listeners for Bookmark Modal
            document.getElementById('bookmark-container').addEventListener('click', (e) => {
                if (e.target.closest('#open-bookmark-modal-btn')) {
                    openBookmarkModal();
                }
            });
            document.getElementById('close-bookmark-modal-btn').addEventListener('click', closeBookmarkModal);
            document.getElementById('add-bookmark-btn').addEventListener('click', handleAddBookmark);

            // Attach event listeners for Background Gallery Modal (NEW)
            document.getElementById('open-background-gallery-btn').addEventListener('click', openBackgroundGalleryModal);
            document.getElementById('close-background-gallery-modal-btn').addEventListener('click', closeBackgroundGalleryModal);
            document.getElementById('add-background-btn').addEventListener('click', handleAddBackground);


            // Search functionality
            document.getElementById('search-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const query = document.getElementById('search-input').value;
                if (query) {
                    // Check if it looks like a URL starting with a domain (e.g., google.com or https://google.com)
                    if (query.includes('.') && !query.includes(' ')) {
                        let url = query.startsWith('http') ? query : `https://${query}`;
                        window.location.href = url;
                    } else {
                        // Use Google search URL
                        window.location.href = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
                    }
                }
            });

            // The data listeners are now initiated inside initFirebase on successful authentication.
        };

    </script>
</head>
<body class="bg-gray-900">

    <div id="background-container"></div>

    <div class="scroll-container flex justify-center items-start lg:items-center">

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 w-full max-w-7xl pt-16 lg:pt-0 pb-16">

            <div class="lg:col-span-1 p-6 bg-white/10 rounded-3xl backdrop-blur-xl shadow-2xl h-fit">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-white flex items-center">
                        <span data-lucide="graduation-cap" class="w-6 h-6 mr-2 text-blue-400"></span>
                        MCAST Links
                    </h2>
                    </div>
                <div id="mcast-link-list" class="space-y-3">
                    </div>
            </div>

            <div class="lg:col-span-1 flex flex-col items-center justify-center p-6 space-y-8">
                <form id="search-form" class="w-full max-w-xl relative">
                    <input type="text" id="search-input" placeholder="Search Google or type a URL..."
                            class="w-full p-4 pl-12 bg-white/90 text-gray-900 border-2 border-transparent focus:border-blue-500 rounded-full shadow-lg outline-none transition-all duration-300"
                            autofocus>
                    <span data-lucide="search" class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-500"></span>
                    <button type="submit" class="hidden">Search</button>
                </form>

                <div id="bookmark-container" class="grid grid-cols-4 gap-4 sm:gap-6 p-4 rounded-3xl bg-white/5 backdrop-blur-md shadow-inner">
                    </div>

                <div class="flex justify-center w-full">
                    <button id="open-background-gallery-btn"
                            class="flex items-center text-sm text-white/70 hover:text-white transition-colors p-3 rounded-full bg-white/10 hover:bg-white/20">
                        <span data-lucide="gallery-vertical" class="w-4 h-4 mr-2"></span>
                        Manage Backgrounds
                    </button>
                </div>

                <p id="user-id-display" class="text-xs text-white/50 mt-4"></p>
            </div>

            <div class="lg:col-span-1 p-6 bg-white/10 rounded-3xl backdrop-blur-xl shadow-2xl h-fit">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-white flex items-center">
                        <span data-lucide="calendar-check" class="w-6 h-6 mr-2 text-green-400"></span>
                        Upcoming Assignments
                    </h2>
                    <button id="open-assignment-modal-btn"
                            class="w-8 h-8 flex items-center justify-center bg-green-500 text-white rounded-full shadow-lg hover:bg-green-600 transition-transform transform hover:scale-110"
                            title="Add New Assignment">
                        <span data-lucide="plus" class="w-5 h-5"></span>
                    </button>
                </div>

                <div id="assignment-list" class="space-y-3">
                    </div>
            </div>
        </div>
    </div>

    <div id="assignment-modal"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700 transform transition-all duration-300 scale-100">
            <h3 class="text-2xl font-bold text-white mb-6">Add New Assignment</h3>
            <div class="space-y-4">
                <input type="text" id="assignment-title" placeholder="Assignment Title (e.g., Final Paper)"
                        class="w-full p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-blue-500 outline-none transition-colors">
                <input type="date" id="assignment-deadline"
                        class="w-full p-3 rounded-xl bg-gray-700 text-white border border-gray-600 focus:border-blue-500 outline-none transition-colors">
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="close-assignment-modal-btn"
                        class="px-5 py-2 rounded-xl bg-gray-600 text-white hover:bg-gray-500 transition-colors">
                    Cancel
                </button>
                <button id="add-assignment-btn"
                        class="px-5 py-2 rounded-xl bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-colors">
                    Save Assignment
                </button>
            </div>
        </div>
    </div>

    <div id="bookmark-modal"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700 transform transition-all duration-300 scale-100">
            <h3 class="text-2xl font-bold text-white mb-6">Add New Bookmark</h3>
            <div class="space-y-4">
                <input type="text" id="bookmark-name" placeholder="Name (e.g., Google News)"
                        class="w-full p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-blue-500 outline-none transition-colors">
                <input type="url" id="bookmark-url" placeholder="URL (e.g., https://news.google.com)"
                        class="w-full p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-blue-500 outline-none transition-colors">
                <input type="text" id="bookmark-icon" placeholder="Lucide Icon Name (e.g., 'globe', 'mail')"
                        class="w-full p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-blue-500 outline-none transition-colors">
            </div>
            <div class="flex justify-end space-x-4 mt-6">
                <button id="close-bookmark-modal-btn"
                        class="px-5 py-2 rounded-xl bg-gray-600 text-white hover:bg-gray-500 transition-colors">
                    Cancel
                </button>
                <button id="add-bookmark-btn"
                        class="px-5 py-2 rounded-xl bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-colors">
                    Save Bookmark
                </button>
            </div>
        </div>
    </div>

    <div id="background-gallery-modal"
         class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 transition-opacity duration-300 opacity-0 pointer-events-none z-50">
        <div class="bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-4xl border border-gray-700 transform transition-all duration-300 scale-100 h-5/6 flex flex-col">
            <h3 class="text-2xl font-bold text-white mb-6 flex items-center">
                <span data-lucide="gallery-vertical" class="w-6 h-6 mr-2"></span>
                Manage Your Backgrounds
            </h3>

            <div class="flex-grow overflow-y-auto pr-2 mb-6 space-y-4">
                <h4 class="text-lg font-semibold text-white mb-3 border-b border-gray-700 pb-2">Select or Delete</h4>
                <div id="background-gallery-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                    <p class="text-white/50 text-center col-span-full">Loading backgrounds...</p>
                </div>
                
                <h4 class="text-lg font-semibold text-white mb-3 pt-6 border-t border-gray-700 pt-4">Add New Background</h4>
                
                <div class="space-y-4">
                     <p class="text-sm text-white/70">Upload an image file (e.g., JPG, PNG). Max size: 2MB.</p>
                    <input type="text" id="background-file-name" placeholder="Optional: Give this background a name"
                            class="w-full p-3 rounded-xl bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:border-blue-500 outline-none transition-colors">
                    <input type="file" id="background-image-file" accept="image/*"
                            class="w-full text-white/80 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-500 file:text-white hover:file:bg-blue-600">
                </div>
            </div>

            <div class="flex justify-end space-x-4 mt-auto border-t border-gray-700 pt-4">
                 <button id="close-background-gallery-modal-btn"
                        class="px-5 py-2 rounded-xl bg-gray-600 text-white hover:bg-gray-500 transition-colors">
                    Close Gallery
                </button>
                <button id="add-background-btn"
                        class="px-5 py-2 rounded-xl bg-green-500 text-white font-semibold hover:bg-green-600 transition-colors">
                    Upload Image
                </button>
            </div>
        </div>
    </div>
    </body>

</html>
